# Screen Manager Alert Manager

* Proposal: [SDL-NNNN](NNNN-screen-manager-alerts.md)
* Author: [Joel Fischer](https://github.com/joeljfischer)
* Status: **Awaiting review**
* Impacted Platforms: [iOS / Java Suite / JavaScript Suite]

## TODO
- [ ] Java Suite / JavaScript Suite APIs

## Introduction
This proposal adds alert management and handling to the screen manager API.

## Motivation
The screen manager should be capable of handling all screen related RPCs and features. Text, graphics, soft buttons, menus, and choice interactions are currently handled, but alerts are not.

## Proposed solution
The proposed solution is to add a new private `SDLAlertManager` sub-manager to the screen manager to handle alert-related capabilities, soft buttons and their images, text concatenation, etc. The `SDLScreenManager` itself will then provide a simple public API for presenting alerts to the screen.

### Audio Processing
In order to support complicated `Alert`'s complicated audio processing as well as future support for other RPCs such as `Speak`, we need to add new classes that handle audio to be played in a high-level way. This will be supported by using a "class-cluster" or "facade" design pattern to reduce duplicate implementation code and to present to the developer only the information that is important to that particular API.

#### iOS
The `SDLAudioData` class is a private class containing the actual data that the facade classes will present. It has all available data on it and each facade will present or hide data as needed. This class can be extended as needed to support RPC parameters such as `muteAudio` for `PerformAudioPassThru` in the future.

```objc
/**
 This class is intended to be used by SDLScreenManager for various APIs that deal with TTSChunks. However, it is a private class that is used by various other "facade" classes that expose the APIs that are needed by that particular RPC. For example, the Speak RPC does not support a "tone" so the facade class for Speak audio data will not expose that parameter or an initializer with that parameter.
*/
@interface SDLAudioData: NSObject

/**
 Whether the alert tone should be played before the prompt (if any) is spoken. Defaults to NO. Only works on `Alert`s and will be ignored on other alert types.
 */
@property (assign, nonatomic) BOOL playTone;

/**
 The underlying prompt generated by the `init`.
 */
@property (nullable, copy, nonatomic) NSArray<SDLTTSChunk *> *prompt;

/**
 If created with an audio file, the audio file that will be uploaded and used.
 */
@property (nullable, copy, nonatomic) SDLFile *audioFile;

@end
```

The next class is the facade class for alerts. Other facades can be created, such as one for the `Speak` RPC that doesn't have any initializer for `playTone`. This class will create and hold a private object of type `SDLAudioData`.

```objc
@interface SDLAlertAudioData: NSObject

/**
 Whether the alert tone should be played before the prompt (if any) is spoken. Defaults to NO. Only works on `Alert`s and will be ignored on other alert types.
 */
@property (assign, nonatomic) BOOL playTone;

/**
 The underlying prompt generated by the `init`.
 */
@property (nullable, copy, nonatomic) NSArray<SDLTTSChunk *> *prompt;

/**
 If created with an audio file, the audio file that will be uploaded and used.
 */
@property (nullable, copy, nonatomic) SDLFile *audioFile;

/**
 Initialize with an SDLFile holding data or pointing to a file on the file system. When this object is passed to an `Alert` or `Speak`, the file will be uploaded if it is not already, then played if the system supports that feature.

 Only available on SDL Core 5.0+.

 @param audioFile The audio file to be played by the system
 @param tone Whether or not to play a system tone before the audio file
 */
- (instancetype)initWithAudioFile:(SDLFile *)audioFile playSystemTone:(BOOL)tone;

/**
 Initialize with a string to be spoken by the system speech synthesizer.

 @param spokenString The string to be spoken by the system speech synthesizer
 @param tone Whether or not to play a system tone before the synthesized speech
 */
- (instancetype)initWithSpeechSynthesizerString:(NSString *)spokenString playSystemTone:(BOOL)tone;

/**
 Initialize with a string to be spoken by the system speech synthesizer using a phonetic string.

 @param spokenString The string to be spoken by the system speech synthesizer
 @param phoneticType Must be one of `SAPI_PHONEMES`, `LHPLUS_PHONEMES`, `TEXT`, or `PRE_RECORDED` or no object will be created
 @param tone Whether or not to play a system tone before the synthesized speech
 */
- (instancetype)initWithPhoneticSpeechSynthesizerString:(NSString *)phoneticString phoneticType:(SDLSpeechCapabilities)phoneticType playSystemTone:(BOOL)tone;

/**
 Initialize with only a tone.
 */
- (instancetype)initWithTone;
```

### Manager Alert API
The next object is the alert view itself that developers will construct and pass to the Screen Manager.

#### iOS
```objc
@interface SDLAlertView: NSObject

/**
 Set this to change the default timeout for all alerts. If a timeout is not set on an individual alert object (or if it is set to 0.0), then it will use this timeout instead. See `timeout` for more details. If this is not set by you, it will default to 5 seconds. The minimum is 3 seconds, the max is 10 seconds. If this is set below the minimum, it will be capped at 3 seconds. If this is set above the maximum, it will be capped at 10 seconds.
 */
@property (class, assign, nonatomic) NSTimeInterval defaultTimeout;

/**
 Maps to Alert.alertText1. The primary line of text for display on the alert. If fewer than three alert lines are available on the head unit, the screen manager will automatically concatenate some of the lines together.
 */
@property (nullable, strong, nonatomic) NSString *text;

/**
 Maps to Alert.alertText2. The secondary line of text for display on the alert. If fewer than three alert lines are available on the head unit, the screen manager will automatically concatenate some of the lines together.
 */
@property (nullable, strong, nonatomic) NSString *secondaryText;

/**
 Maps to Alert.alertText3. The tertiary line of text for display on the alert. If fewer than three alert lines are available on the head unit, the screen manager will automatically concatenate some of the lines together.
 */
@property (nullable, strong, nonatomic) NSString *tertiaryText;

/**
 Maps to Alert.duration. Defaults to `defaultTimeout`. If set to 0, it will use `defaultTimeout`. If this is set below the minimum, it will be capped at 3 seconds. Minimum 3 seconds, maximum 10 seconds. If this is set above the maximum, it will be capped at 10 seconds. Defaults to 0.
 */
@property (assign, nonatomic) NSTimeInterval timeout;

/**
 Maps to Alert.ttsChunks and Alert.playTone. This text is spoken when the alert appears.
 */
@property (nullable, copy, nonatomic) SDLAlertAudioData *audio;

/**
 Maps to Alert.progressIndicator. If supported, the alert GUI will display some sort of indefinite waiting / refresh / loading indicator animation. Defaults to NO.
 */
@property (assign, nonatomic) BOOL showWaitIndicator;

/**
 Maps to Alert.softButtons. Soft buttons the user may select to perform actions. Only one `SDLSoftButtonState` per object is supported; if any soft button object contains multiple states, an exception will be thrown.
 */
@property (nullable, copy, nonatomic) NSArray<SDLSoftButtonObject *> *softButtons;

/**
 Maps to Alert.alertIcon. An artwork that will be displayed when the icon appears. This will be uploaded prior to the appearance of the alert if necessary. This will not be uploaded if the head unit does not declare support for alertIcon.
*/
@property (nullable, copy, nonatomic) SDLArtwork *icon;

- (instancetype)initWithText:(NSString *)text buttons:(NSArray<SDLSoftButtonObject *> *)softButtons;

- (instancetype)initWaitingIndicatorAlertWithText:(nullable NSString *)text secondaryText:(nullable NSString *)secondaryText teritaryText:(nullable NSString *)tertiaryText timeout:(NSTimeInterval)timeout audioIndication:(nullable SDLAlertAudioData *)audio buttons:(nullable NSArray<SDLSoftButtonObject *> *)softButtons icon:(nullable SDLArtwork *)icon;

/**
 Cancels the alert. If the alert has not yet been sent to Core, it will not be sent. If the alert is already presented on Core, the alert will be immediately dismissed. Canceling an already presented alert will only work if connected to Core versions 6.0+. On older versions of Core, the alert will not be dismissed.
*/
- (void)cancel;

@end
```

And then the additions to the screen manager public API itself to present the alert.

```objc
@interface SDLScreenManager: NSObject
// Everything already there

/**
 Present the alert on the screen.
 
 If the alert contains an audio indication with a file that needs to be uploaded, it will be uploaded before presenting the alert. If the alert contains soft buttons with images, they will be uploaded before presenting the alert. If the alert contains an icon, that will be uploaded before presenting the alert.
 
 The handler will be called when the alert either dismisses from the screen or it has failed to present. If the error value in the handler is present, then the alert failed to appear, if not, then the alert dismissed without error. The error will contain `userInfo` with information on how long to wait before retrying.
 */
- (void)presentAlert:(SDLAlertView *)alert withCompletionHandler:(nullable SDLScreenManagerUpdateCompletionHandler)handler;

@end
```

### Additional Implementation Notes
- The internal alert manager will observe the screen context to know when the alert has been presented, and then call the `completionHandler`.
- The internal alert manager will always send the alert, even if the system context is not MAIN. If the `AlertResponse` returns an failure to present, it will call the `completionHandler` with the error.
- The developer will not be notified when the alert appears on the screen, assuming no error occurred.

## Potential downsides
The creation of the alert sub-manager will be complex because it has to handle the creation of soft buttons and manage their ids alongside the soft button manager. It will also have to upload the icon image, soft button images, and audio files. However, this is all complexity that every SDL developer must currently consider when developing their app. This is especially difficult for them because they don't usually have to deal with uploading images and waiting until it's done.

## Impact on existing code
This is a minor version change for all proxy libraries.

## Alternatives considered
1. We could change the completion handler to a delegate in order to cover more cases, like so:

```objc
@protocol SDLAlertViewDelegate <NSObject>

- (void)alertView:(SDLAlertView *)alertView didFailToAppearWithError:(NSError *)error
- (void)alertViewDidAppear:(SDLAlertView *)alertView;
- (void)alertViewDidDismiss:(SDLAlertView *)alertView;

@end
```

The alert view would then have a new required delegate property, and the screen manager API would not take a completion handler.

2. We could add a second block handler to the `presentAlert` call to allow the developer to be notified when the alert appears as well as dismisses.

3. We could have used subclasses instead of the facade pattern for audio data, however that would result in APIs being available publicly on the facade classes that should not be, such as properties or initializers. The private implementation class would also then have to be public.

4. We could have used an interface instead of the facade pattern for audio data, but that would require that the implementation be copied across classes and they will have public APIs that should not be available.