# WiFi Transport: Sharing SSID and password with Mobile Proxy

* Proposal: [SDL-0245](0245-sharing-wifi-ssid-and-password.md)
* Author: [Ashwin Karemore](https://github.com/ashwink11)
* Status: **Returned for Revisions**
* Impacted Platforms: [Java Suite / iOS / RPC / Core / HMI]

## Introduction

This proposal describes a way by which HMI can share WiFi credentials with mobile proxy when SDL is using WiFi as secondary transport.

## Motivation

In the current implementation of SDL over WiFi transport, IP address and port are shared with Mobile proxy. However, the prerequisite for using SDL over WiFi transport is that the mobile device should be connected to WiFi.
In some cases, entering a password for the access point created by HMI could be tedious and it would be a lot more convenient for users if Mobile Apps could automatically connect to a WiFi access point.

If WiFi access point credentials are automatically generated by HMI, the password could contain special characters or it could be just too long. It would be inconvenient for the user to enter such passwords in HMI. Another possible scenario is, HMI could keep changing passwords to improve the security of the network. In such cases, a user might need to connect to WiFi network every time password is changed.

## Proposed solution

The available transport type for Secondary Transport can be configured through smartDeviceLink.ini file. 

If `MultipleTransportsEnabled` is set as `true` and `Secondary Transport` is `WiFi` in `smartDeviceLink.ini` configuration file. HMI could create a WiFi Access Point and the WiFi credentials can be communicated to the mobile proxy.

Android and iOS provide APIs to connect to a WiFi network in case WiFi SSID and password is known. These APIs could be used in Mobile Proxy to connect to the WiFi access point created by HMI. The flow for the proposed solution would be:

`HMI creates WiFi Access Point --> HMI provides WiFi Access point credentials to SDL Core --> SDL Core shares WiFi credentials using Primary Transport --> Mobile Proxy receives WiFi access point credentials  --> Mobile Proxy automatically connects to the WiFi access point.`

### HMI API changes

1. HMI will create a WiFi access point and communicate these using below HMI API.
2. HMI will notify SDL Core using `OnWiFiTransportStatusUpdate` whenever WiFi state is changed.
3. Device Info is changed to provide WiFi auto-connect feature support information to HMI. 
4. HMI will receive `DeviceInfo.supportWiFiAutoConnect` in `RegisterAppInterface` Request using `primary transport`.
5. HMI can send `OnSystemRequest` notification with `RequestType` as `CONNECT_WIFI` to inform app to try connecting WiFi. This notification will be sent only when a user has provided consent to share WiFi credentials, and the connected app supports WiFi auto-connect and the user attempts to launch that app.
6. HMI will not send `OnSystemRequest` notification with `RequestType` as `CONNECT_WIFI` if app is already connected using WiFi.

```
<interface name="Common" version="X.X.X" date="2019-XX-XX">
<struct name="DeviceInfo" since="X.X">
  .
  .
  .
  <param name="supportWiFiAutoConnect" type="Boolean" mandatory="false">
    <description>support to connect WiFi enabled by developer and is supported by mobile device.</description>
  </param>         
</struct> 

<enum name="RequestType">
  .
  .
  .
  <element name="CONNECT_WIFI" />
</enum>
</interface>

<interface name="BasicCommunication" version="X.X.X" date="2019-XX-XX">
	.
	.
	.
  <function name="OnWiFiTransportStatusUpdate" messagetype="notification">
      <description>HMI must notify SDL about WiFi Access point.</description>
	    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
        <description>name of the WiFi ssid</description>
      </param>
	    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
      </param>
	    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
      </param>
      <param name="wifiState" type="WiFiStateInfo" mandatory="false">
        <description>wifi state info</description>
      </param>
  </function>
</interface>
```

Enum to define WiFi state and WiFi security type.

```
<enum name="WiFiSecurityType">
  <description>enum to define WiFi security types used for WiFi connection.</description>
  <element name="WIFI_SECURITY_NONE"/>
  <element name="WIFI_SECURITY_WEP"/>
  <element name="WIFI_SECURITY_WPA"/>
  <element name="WIFI_SECURITY_WPA2 "/>
</enum>

<enum name="WiFiStateInfo">
  <description>enum to define WiFi state.</description>
  <element name="WIFI_STATE_DISABLED"/>
  <element name="WIFI_STATE_ENABLED"/>
</enum>
```

### Mobile API changes

1. The proxy can connect to WiFi using APIs provided by the platform if SSID, password and security type are known. However, these APIs need special permissions or entitlements. 
2. App developers can choose if they want to provide these permissions or not. Hence, app developers should be able to configure OFF WiFi auto-connection feature using proxy API. 
3. The proxy will provide an API to app developers to configure ON/OFF WiFi auto-connection. If app developers use this API to configure ON WiFi auto-connection, the proxy should request WiFi status info from SDL Core using below API. 
4. The proxy should send `DeviceInfo.supportWiFiAutoConnect` information along with `RegisterAppInterface` request.
5. If the mobile device supports WiFi connection APIs provided by platform and app developer configured ON WiFi auto-connect feature, only then proxy should send `DeviceInfo.supportWiFiAutoConnect` as `true`.
6. The proxy should request WiFi status info only if supported secondary transport is WiFi, as defined in proposal [SDL-0141](https://github.com/smartdevicelink/sdl_evolution/blob/13031dfe6d17c20fdbc673b4ac0016992d765fcd/proposals/0141-multiple-transports.md#starting-secondary-transport). This information is provided with `Start Service ACK` during version negotiations. 
7. If the proxy did not receive WiFi credentials using `GetWiFiStatusInfo` due to some error, the proxy should request credentials again using `GetWiFiStatusInfo` only after receiving `Transport Event Update` with a valid IP address. `Transport Event Update` behavior is defined in proposal [SDL-0141](https://github.com/smartdevicelink/sdl_evolution/blob/13031dfe6d17c20fdbc673b4ac0016992d765fcd/proposals/0141-multiple-transports.md).
8. The proxy will receive `Transport Event Update` with an empty IP address when TCP transport is unavailable. The proxy will not try connecting WiF if `Transport Event Update` with an empty IP address is received. 
9. The proxy should try connecting to WiFi only when Driver Distraction is OFF.
10. The proxy should try connecting to WiFi as soon as possible upon receiving `OnSystemRequest` notification with `CONNECT_WIFI` request type. 
11. Policy table should be updated to include below-mentioned RPCs. These RPCs should be updated in aseparate `functional group`, so that, if required, the user can specifically disable WiFi credentials and status sharing with their app while allowing other RPCs. OEMs, if they require, can enable the RPC message protection feature for below-mentioned Mobile APIs.
12. SDL Core should check the policy table and user consent to share WiFi status info before sending a response for below-mentioned RPCs. 

```
<enum name="FunctionID" internal_scope="base" since="1.0">
  .
  .
  .
  <element name="GetWiFiStatusInfoID" value="XX" hexvalue="XX" since="X.X" />
</enum>

<enum name="RequestType">
  .
  .
  .
  <element name="CONNECT_WIFI" />
</enum>

<struct name="DeviceInfo" since="X.X">
  .
  .
  .
  <param name="supportWiFiAutoConnect" type="Boolean" mandatory="false">
    <description>support to connect WiFi enabled by developer and is supported by mobile device.</description>
  </param>         
</struct> 

<enum name="WiFiStateInfo">
  <description>enum to define WiFi state.</description>
  <element name="WIFI_STATE_DISABLED"/>
  <element name="WIFI_STATE_ENABLED"/>
</enum>

<enum name="WiFiSecurityType">
  <description>enum to define WiFi security types used for WiFi connection.</description>
  <element name="WIFI_SECURITY_NONE">
    <description>No security protocol used.</description>
  </element>
  <element name="WIFI_SECURITY_WEP">
      <description>WEP security protocol should be used. </description>
  </element>
  <element name="WIFI_SECURITY_WPA">
      <description>WPA security protocol should be used.</description>
  </element>
  <element name="WIFI_SECURITY_WPA2 ">
      <description>WPA2 security protocol should be used.</description>
  </element>
</enum>

<function name="GetWiFiStatusInfo" functionID="GetWiFiStatusInfoID" messagetype="request" since="X.X">
  <description>RPC sent by proxy to request WiFi status info from SDL Core.</description>
</function>

<function name="GetWiFiStatusInfo" functionID="GetWiFiStatusInfoID" messagetype="response" since="X.X">
  <param name="success" type="Boolean" platform="documentation" mandatory="true">
    <description> true, if successful; false, if failed </description>
  </param>
        
  <param name="resultCode" type="Result" platform="documentation" mandatory="true">
    <description>See Result</description>
    <element name="SUCCESS"/>
    <element name="UNSUPPORTED_RESOURCE">
    <element name="DISALLOWED"/>
    <element name="REJECTED">
    <element name="TOO_MANY_PENDING_REQUESTS"/>
    <element name="APPLICATION_NOT_REGISTERED"/>
    <element name="GENERIC_ERROR"/>
    <element name="USER_DISALLOWED"/>
    <element name="DATA_NOT_AVAILABLE"/>
  </param>
        
  <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
    <description>Provides additional human readable info regarding the result.</description>
  </param> 
  <param name="wifiState" type="WiFiStateInfo" mandatory="false">
    <description>wifi state info</description>
  </param>
  <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
      <description>name of the WiFi ssid</description>
  </param>
	<param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
    <description>password to use to connect AP</description>
  </param>
	<param name="securityType" type="WiFiSecurityType" mandatory="false">
    <description>security type of WiFi AP</description>
  </param>   
</function>

```

Possible responses for the above mentioned RPCs.

1. RPC response will be `SUCCESS` if the request is successful.
2. RPC response will be `UNSUPPORTED_RESOURCE` if HMI does not support WiFi transport for SDL.
3. RPC response will be `DISALLOWED` if RPC is not authorized in the local policy table.
4. RPC response will be `GENERIC_ERROR` if request cannot be processed due to some internal error.
5. RPC response will be `USER_DISALLOWED` if user disabled WiFi status info sharing with the app.
6. RPC response will be `DATA_NOT_AVAILABLE` if WiFi status info is not available with SDL Core. 

## Potential downsides

Apps need to include additional permissions to use APIs to connect to WiFi. However, it would provide convenience to users if Apps can connect to HMI automatically instead of the manual process and thus outweighs mentioned downside.

## Impact on existing code

### Changes in SDL Core

1. Implementation of HMI API described above in Core. 
2. Implementation of Mobile API described above in SDL Core.
3. Implementation to handle additional `functional group` for WiFi.
4. SDL Core will cache `WiFi credentials` received from HMI and will be able to share them with other apps if permitted by policies.

### Policy Changes

1. Policy table needs to be updated for the new Mobile API.
2. The new functional group should be created so that, if required, the user can explicitly disable sharing of WiFi status info.

### Proxy Changes

1. The proxy needs to implement Mobile API mentioned above.
2. The proxy should provide an API to enable/disable WiFi auto-connect feature.
3. The proxy should be able to check the mobile device OS version. In case platform API support to connect WiFi is not available in a mobile device, the proxy should be able to dynamically configure OFF WiFi auto-connect feature at run time.
4. The proxy should set `DeviceInfo.supportWiFiAutoConnect` to `true` if WiFi auto-connect is configured ON by App developer and mobile device supports platform API to connect WiFi.
5. The proxy should set `DeviceInfo.supportWiFiAutoConnect` to `false`, either if WiFi auto-connect is configured OFF by developer or mobile device does not support platform API to connect WiFi.
6. If App developers use this API to enable WiFi auto-connection feature, they should provide below permissions/entitlements:
>*  Android App will need to include WiFi permissions.
>*  iOS App will need to add `Hotspot Configuration` Capability.
7. The proxy should connect WiFi only if App developer enabled WiFi auto-connect feature.
8. The proxy should request WiFi status information using the above-mentioned API only if WiFi auto-connection is enabled by App developer, the mobile device supports platform API to connect WiFi and WiFi is supported as `secondary transport`.
9. The proxy should rely on error callbacks and return values to know whether WiFi connection using platform APIs was successful or failed. 


### Sample Code for WiFi Connection in Android

Below code can be used to connect to WiFi Access point if SSID and password are known.

```
    private void connectToWiFi(String ssid,String password){
        WifiConfiguration conf = new WifiConfiguration();
        conf.SSID = "\"" + ssid + "\"";
        conf.preSharedKey = "\""+ password +"\"";

        m_wifiManager.addNetwork(conf);
        List<WifiConfiguration> list = m_wifiManager.getConfiguredNetworks();
        for( WifiConfiguration i : list ) {
            if(i.SSID != null && i.SSID.equals("\"" + ssid + "\"")) {
                m_wifiManager.disconnect();
                m_wifiManager.enableNetwork(i.networkId, true);
                m_wifiManager.reconnect();
                break;
            }
        }
    }
```
Permissions required to use above mentioned API's are as follows:

```
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
```
### Sample Code for WiFi Connection in iOS

Below code can be used to connect to WiFi Access point if SSID and password are known.

```
    NEHotspotConfiguration * config = [[NEHotspotConfiguration alloc] initWithSSID:ssid passphrase:password isWEP:NO];
    [config setJoinOnce:NO];
    
    NEHotspotConfigurationManager* configManager = [NEHotspotConfigurationManager sharedManager];
    [configManager applyConfiguration:config completionHandler:^(NSError * _Nullable error) {
        [self showAlert:[error localizedDescription]];
        NSLog(@"Error %@",[error debugDescription]);
    }];
```
Capabilities required to use above mentioned APIs are as follows:

```
Hotspot Configuration
```

#### Steps to enable entitlements for iOS App

* Apple developer/enterprise account needed to add required entitlement in the provisioning profile.
* Enable required entitlements for your project in XCode. More info can be found in below links.
https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_developer_networking_hotspotconfiguration
https://help.apple.com/xcode/mac/current/#/dev88ff319e7
  

## Alternatives considered

1. The proxy can know the status of the current WiFi connection using APIs provided in Android and iOS SDK. However, these APIs requires additional permissions and entitlements. 

2. Instead of depending on `Transport Event Update` to know WiFi connection state, `subscription` methods could be provided in mobile API, as defined below. However, this would increase the number of available RPC's for WiFi.

```
<enum name="FunctionID" internal_scope="base" since="1.0">
  .
  .
  .
  <element name="SubscribeWiFiStatusUpdatesID" value="XX" hexvalue="XX" since="X.X" />
  <element name="UnsubscribeWiFiStatusUpdatesID" value="XX" hexvalue="XX" since="X.X" />
  <element name="OnWiFiStatusUpdateID" value="XXXX" hexvalue="XXXX" since="X.X" />
</enum>

<function name="SubscribeWiFiStatusUpdates" functionID="SubscribeWiFiStatusUpdatesID" messagetype="request" since="X.X">
  <description>RPC sent by proxy to subscribe to WiFi status info.</description>
</function>

<function name="SubscribeWiFiStatusUpdates" functionID="SubscribeWiFiStatusUpdatesID" messagetype="response" since="X.X">
  <param name="success" type="Boolean" platform="documentation" mandatory="true">
    <description> true, if successful; false, if failed </description>
  </param>
        
  <param name="resultCode" type="Result" platform="documentation" mandatory="true">
    <description>See Result</description>
    <element name="SUCCESS"/>
    <element name="UNSUPPORTED_RESOURCE">
    <element name="DISALLOWED"/>
    <element name="REJECTED">
    <element name="TOO_MANY_PENDING_REQUESTS"/>
    <element name="APPLICATION_NOT_REGISTERED"/>
    <element name="GENERIC_ERROR"/>
    <element name="USER_DISALLOWED"/>
    <element name="IGNORED"/>
  </param>
        
  <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
    <description>Provides additional human readable info regarding the result.</description>
  </param> 
</function>

<function name="UnsubscribeWiFiStatusUpdates" functionID="UnsubscribeWiFiStatusUpdatesID" messagetype="request" since="X.X">
  <description>RPC sent by proxy to subscribe to WiFi status info.</description>
</function>

<function name="UnsubscribeWiFiStatusUpdates" functionID="UnsubscribeWiFiStatusUpdatesID" messagetype="response" since="X.X">
  <param name="success" type="Boolean" platform="documentation" mandatory="true">
    <description> true, if successful; false, if failed </description>
  </param>
        
  <param name="resultCode" type="Result" platform="documentation" mandatory="true">
    <description>See Result</description>
    <element name="SUCCESS"/>
    <element name="UNSUPPORTED_RESOURCE">
    <element name="DISALLOWED"/>
    <element name="REJECTED">
    <element name="TOO_MANY_PENDING_REQUESTS"/>
    <element name="APPLICATION_NOT_REGISTERED"/>
    <element name="GENERIC_ERROR"/>
    <element name="USER_DISALLOWED"/>
    <element name="IGNORED"/>
  </param>
        
  <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
    <description>Provides additional human readable info regarding the result.</description>
  </param> 
</function>

<function name="OnWiFiStatusUpdate" functionID="OnWiFiStatusUpdateID" messagetype="notification" since="X.X">
  <description>Callback for the periodic and non periodic WiFi status information.</description>
  <param name="wifiState" type="WiFiStateInfo" mandatory="false">
    <description>wifi state info</description>
  </param>
  <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
      <description>name of the WiFi ssid</description>
  </param>
	<param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
    <description>password to use to connect AP</description>
  </param>
	<param name="securityType" type="WiFiSecurityType" mandatory="false">
    <description>security type of WiFi AP</description>
  </param>    
</function>

```


## Recommended use case flow

The use cases defined are applicable only for video streaming Apps. These use case recommendations are made considering the following pre-conditions:

1. HMI allows App registration of all apps using `primary transport`.
2. HMI does not allow video streaming Apps use cases using `primary transport`.
3. The mobile device supports WiFi connection APIs and App developer enabled WiFi auto-connect using APIs provided by a proxy. Value received for `DeviceInfo.supportWiFiAutoConnect` is `true`.
4. `WiFi` is supported secondary transport.
5. HMI sends `WiFi` credentials to SDL Core using `HMI API` mentioned above.
6. The proxy receives `Start Service Ack` with supported `secondaryTransports` as `WiFi`. 

### **A. `WiFi` credentials not shared with App**

This case is applicable when the Policy table is not updated or user disallowed it.

#### Scenario Description
1. The proxy requests `WiFi` status info.
2. SDL Core responds with `DISALLOWED` if the policy table is not updated.
3. User tries to launch the App on HMI.
4. HMI shows "Waiting for Permission updates" pop up with timeout of 5 seconds.

#### Post Conditions 

WiFi credentials not shared with App.

### **B. Policy table updated and user consent needed**

This case is applicable when the Policy table is updated and the user did not provide consent to share WiFi credentials.

#### Scenario Description
1. If the proxy requests `WiFi` status info before user consent, SDL Core responds with `DISALLOWED`.
2. User tries to launch the App on HMI.
3. HMI determines that WiFi auto-connect is supported using `DeviceInfo.supportWiFiAutoConnect`.
4. HMI requests `GetListOfPermissions` and determines if `WiFi group` permissions needed.
5. HMI requests user consent to share WiFi credentials with App and informs the user that credentials can be used by the App to connect WiFi automatically.
6. The user provides consent to share WiFi credentials with App. 
7. HMI shows `Waiting for WiFi Connection. Please check your device when it is safe to do so. Apps on some devices may need your permissions to connect Car WiFi.` popup with a timeout of 5 seconds.

#### Post Conditions 

1. The proxy receives `OnPermissionChange` notification. As soon as this notification is received, the proxy requests WiFi credentials using `GetWiFiStatusInfo` Mobile API. 
2. HMI sends `OnSystemRequest` notification with `CONNECT_WIFI` request type.
3. WiFi credentials shared with the proxy.
4. The proxy should try connecting to WiFi as soon as possible on receiving `OnSystemRequest` notification with `CONNECT_WIFI` request type

#### Exceptions

##### Consent to share WiFi credentials not provided

User did not provide consent to share WiFi credentials

1. User tries to launch the App on HMI.
2. HMI requests `GetListOfPermissions` and determines if `WiFi group` permissions needed.
3. HMI requests user consent to share WiFi credentials with App and informs the user that credentials can be used by the App to connect WiFi automatically.
4. User did not provide consent to share WiFi credentials with App.
5. HMI shows `Connect WiFi to use this App` popup with a timeout of 5 seconds.

##### HMI Pop up `Waiting for WiFi Connection` timeouts

This case would arise if the WiFi connection API's fails for any reason.

1. User tries to launch the App on HMI.
2. HMI shows `Connect WiFi to use this App` popup with a timeout of 5 seconds.

### **C. Policy table updated and user consent provided**

This case is applicable when the Policy table is updated and user-provided consent to share WiFi credentials.

#### Scenario Description
1. If the proxy requests `WiFi` status info, SDL Core responds with `SUCCESS` and provides WiFi credentials to App.
2. User tries to launch the App on HMI.
3. HMI sends `OnSystemRequest` notification with `CONNECT_WIFI` request type.
4. HMI shows `Waiting for WiFi Connection. Please check your device when it is safe to do so. Some devices may need your permissions to connect Car WiFi.` popup with a timeout of 5 seconds.

#### Post Conditions 

1. WiFi credentials shared with App.
2. The proxy connects to WiFi using credentials provided by HMI.

#### Exceptions

##### HMI Pop up `Waiting for WiFi Connection` timeouts

This case would arise if the WiFi connection API's fails for any reason.

1. User tries to launch the App on HMI.
2. HMI shows `Connect WiFi to use this App` popup with a timeout of 5 seconds.

### **D. Driver distraction is ON**

This case is applicable when Driver distraction is ON.

#### Scenario Description

1. User tries to launch the App on HMI.
2. HMI shows `Connect WiFi to use this App` popup with a timeout of 5 seconds.

#### Post Conditions 

1. User manually connects WiFi to use App.

### **E. WiFi auto-connect feature not enabled for App**

This case is applicable when the mobile device does not support WiFi connection API's or App developer configures it OFF.

#### Scenario Description

1. User tries to launch the App on HMI.
2. HMI shows `Connect WiFi to use this App` popup with a timeout of 5 seconds.

##### Post Conditions 

1. User manually connects WiFi to use app.

#### Additional Queries

1. Should mobile receive Wifi credentials if it is already connected by Wifi transport?
- Yes, the proxy will receive WiFi status notifications even when it is connected to WiFi. This would help in cases when WiFi is disabled and enabled again due to some reasons. The proxy can retry connecting using credentials available.

2. If new application request WiFi updates, should it immediately receive cached WiFi credentials?
- Yes, if allowed by policy, the new app should receive cached WiFi credentials.

3. Should cached Wifi credentials be stored on SDL storage across ignition cycles?
- No. HMI should always update SDL core about WiFi status changes using `OnWiFiTransportStatusUpdate` HMI API. 
