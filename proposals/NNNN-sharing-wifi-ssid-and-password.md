# WiFi Transport: Sharing SSID and password with Mobile Proxy

* Proposal: [SDL-NNNN](NNNN-sharing-wifi-ssid-and-password)
* Author: [Ashwin Karemore](https://github.com/ashwink11)
* Status: **Awaiting review**
* Impacted Platforms: [Java Suite / iOS / RPC / Core]

## Introduction

In the current implementation of SDL with WiFi transport, IP address and port are shared with Mobile proxy. However, the prerequisite for using SDL with WiFi is that the mobile device should connected to WiFi.
In some cases, entering password for the access point created by HMI could be tedious and it would be a lot more convenient for users if Mobile Apps could automatically connect to a WiFi access point.

If WiFi access point credentials are automatically generated by HMI, the password could contain special characters or it could be just too long. It would be inconvenient for the user, to enter such passwords in HMI. Also, to improve the security of the network, it is recommended to keep changing passwords. A user would need to connect to WiFi network every time password is changed.

## Proposed solution

The available transport type for Secondary Transport can be configured through smartDeviceLink.ini file. 

If `MultipleTransportsEnabled` is set as `true` and `SecondaryTransportForBluetooth` is `WiFi` in `smartDeviceLink.ini` configuration file. HMI should create a WiFi Access Point and the WiFi credentials should be communicated to the mobile proxy.

Android and iOS provides API's to connect to a WiFi network in case WiFi SSID and password is known. These API's could be used in Mobile Proxy to connect to the WiFi access point created by HMI. The flow for the proposed solution would be:

`HMI creates WiFi Access Point --> HMI provides WiFi Access point credentials to SDL Core --> SDL Core shares WiFi credentials using Primary Transport --> Mobile Proxy receives WiFi access point credentials and check if it is already connected --> If it's not connected, Mobile Proxy automatically connects to the WiFi access point.`

### Changes for communicating Credentials from HMI to Core

HMI will create a WiFi access point and communicate these using below HMI API.

```
<interface name="BasicCommunication" version="2.1.0" date="2019-XX-XX">
	.
	.
	.
  <function name="OnWiFiTransportAvailable" messagetype="notification">
      <description>HMI must notify SDL about WiFi Access point.</description>
	    <param name="ssid" type="String" minlength="1" maxlength="30" mandatory="true">
        <description>name of the WiFi ssid</description>
      </param>
	    <param name="password" type="String" minlength="1" maxlength="30" mandatory="true">
        <description>password to use to connect AP</description>
      </param>
	    <param name="securityType" type="WiFiSecurityType" mandatory="true">
        <description>secutity type of WiFi AP</description>
      </param>
  </function>
</interface>
```

Enum to define WiFi security type.

```
<enum name="WiFiSecurityType">
  <description>Lists of the wifi security types used for wifi connection to HU.</description>
  <element name="WIFI_SECURITY_NONE"/>
  <element name="WIFI_SECURITY_WEP"/>
  <element name="WIFI_SECURITY_WPA"/>
  <element name="WIFI_SECURITY_WPA2 "/>
</enum>
```

### Changes for communicating Credentials from Core to Proxy

WiFi credentials will be communicated to proxy using `Transport Event Update` control frame. `Transport Event Update` frame will be changed to include the following parameters:

Tag Name     | Type   | Description  
-------------|--------|------------
tcpIpAddress | string | (Optional) Already Available
tcpPort      | int32  | (Optional) Already Available
wifiSSID | string | (Optional) Specify a WiFi SSID proxy can use to connect.
wifiPassword | string | (Optional) Specify a WiFi password to connect specified WiFi access point.
wifiSecurity | string | (Optional) Specify a security mechanism to use.

The `wifiSecurity` field should use predefined `String` to identify WiFi security type.

*Table 1: list of `wifiSecurity` Strings*

String                 | Description
-----------------------|------------
WIFI\_SECURITY\_NONE         | No security protocol used. Password in `Transport Event Update` will be empty.
WIFI\_SECURITY\_WEP               | WEP security protocol should be used. 
WIFI\_SECURITY\_WPA   | WPA security protocol should be used. 
WIFI\_SECURITY\_WPA2 | WPA2 security protocol should be used. 


Here is an example of a parameter included in the Transport Event Update frame:

```json
{
  "tcpIpAddress": "192.168.1.1",
  "tcpPort": 12345,
  "WifiSSID":"InCarWiFiAP",
  "wifiPassword":"12345678",
  "wifiSecurity":"WIFI_SECURITY_WPA2"
}
```

On receiving `Transport Event Update` with WiFi credentials, Proxy should check if the mobile device is already connected to WiFi access point mentioned in `Transport Event Update`. If the mobile device is not already connected, it should try connecting to the WiFi access point. 

On successful connection or if the mobile device is already connected to WiFi access point mentioned in `Transport Event Update`, core and proxy should follow use case described in a proposal [Supporting simultaneous multiple transports](https://github.com/smartdevicelink/sdl_evolution/blob/master/proposals/0141-multiple-transports.md "Supporting simultaneous multiple transports").


## Potential downsides

None

## Impact on existing code

1. Implementation of HMI API described above in Core. 
2. Android App will need to include WiFi permissions in Manifest file if they support WiFi as secondary transport.
3. Network Capability needs to be added in iOS App.
4. Implementation in proxy to connect WiFi.

### Sample Code for WiFi Connection in Android

Below code can be used to connect to Wi-Fi Access point if SSID and password are known.

```
    private void connectToWiFi(String ssid,String password){
        WifiConfiguration conf = new WifiConfiguration();
        conf.SSID = "\"" + ssid + "\"";
        conf.preSharedKey = "\""+ password +"\"";

        m_wifiManager.addNetwork(conf);
        List<WifiConfiguration> list = m_wifiManager.getConfiguredNetworks();
        for( WifiConfiguration i : list ) {
            if(i.SSID != null && i.SSID.equals("\"" + ssid + "\"")) {
                m_wifiManager.disconnect();
                m_wifiManager.enableNetwork(i.networkId, true);
                m_wifiManager.reconnect();
                break;
            }
        }
    }
```
Permissions required to use above mentioned API's are as follows:

```
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
```
### Sample Code for WiFi Connection in iOS

Below code can be used to connect to Wi-Fi Access point if SSID and password are known.

```
    NEHotspotConfiguration * config = [[NEHotspotConfiguration alloc] initWithSSID:ssid passphrase:password isWEP:NO];
    [config setJoinOnce:NO];
    
    NEHotspotConfigurationManager* configManager = [NEHotspotConfigurationManager sharedManager];
    [configManager applyConfiguration:config completionHandler:^(NSError * _Nullable error) {
        [self showAlert:[error localizedDescription]];
        NSLog(@"Error %@",[error debugDescription]);
    }];
```
Capabilities required to use above mentioned API's are as follows:

```
Hotspot Configuration
```
  

## Alternatives considered

None

